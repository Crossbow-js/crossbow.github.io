config:
  progress: true

env:
  IMAGE: shakyshane/crossbow-web

watch:
  default:
    before:
      - build-all
      - '@bg browser-sync start --server public --ss public-html'
    '_src:data:public/js':
      - build-html
      - bs:reload
    'scss':
      - build-css
      - bs:inject

tasks:
  (docker):
    push: '@sh docker push $IMAGE'
    build: '@sh docker build -t $IMAGE .'
    up-dev: '@sh docker-compose up -d'
    up-prod: '@sh docker-compose -f docker-compose.prod.yaml up -d'
    prod:
      - build-all
      - docker:build
      - docker:up-prod

  (clean):
    docker-images:  '@sh docker rmi $(docker images -f "dangling=true" -q)'

  (bs):
    reload: '@npm browser-sync reload'
    inject: '@npm browser-sync reload --files core.css'

  build-all:
    - build-html
    - build-css

  build-css:
    tasks: crossbow-sass
    options:
      input: scss/core.scss
      output: public/css

  build-html:
    tasks: ['tasks/templates.js']
    options:
      config:
        base: _src
        prettyUrls: true
        defaultLayout: default.hbs
      data:
        '$$': 'all:data'
      output: 'public-html'
      input:
        - '_src/*.hbs'
        - '_src/docs/**/*.{md,html,hbs}'
